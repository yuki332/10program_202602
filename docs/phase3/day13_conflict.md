# Day 13: コンフリクト体験と解決 — 同じファイルを同時に編集するとどうなる？

## 学習目標

- Gitのコンフリクト（衝突）が**なぜ**起きるかを理解する
- コンフリクトを**意図的に**発生させる体験をする
- コンフリクトの解決手順を習得する
- チーム開発でコンフリクトを減らす方法を学ぶ

## 題材

`team_docs/team_rules.md` の**同じ行**を全員が編集し、意図的にコンフリクトを発生させる。
その後、手順に沿ってコンフリクトを解決する。

## ファイル構成

```
team_docs/
├── members/          ← Day 11 で作成済み
└── team_rules.md     ← 今日の題材（Day 12 で全員のルールが追記済み）
```

---

## コンフリクトとは

```
       main: "朝会は10時"
           │
     ┌─────┴─────┐
     │            │
  伊藤のブランチ   栗原のブランチ
  "朝会は9時"    "朝会は11時"
     │            │
     └─────┬─────┘
           │
        ？？？  ← Gitは「どっちが正しいかわからない」 = コンフリクト
```

> 同じファイルの同じ行を複数人が変更すると、Gitは**どちらを採用すべきかわからない**。これがコンフリクト。

---

## 準備

### 1. mainを最新状態にする

```bash
git checkout main
git pull
```

### 2. team_rules.md の現在の内容を確認

```bash
cat team_docs/team_rules.md
```

### 3. コンフリクト用の行を講師が追加

講師が `team_rules.md` に以下の行を追加してプッシュする。

```markdown
## 朝会のルール

- 朝会の時間: 10:00（この行を各自が編集する）
```

全員がこの変更を取得する。

```bash
git pull
```

---

## 手順

### フェーズ 1: 全員が同時にブランチを作成する

**3人が同時に**、mainからブランチを作成する。

```bash
# mainにいることを確認
git checkout main
git pull

# 各自のブランチを作成
# 伊藤:
git checkout -b feature/morning-itoh

# 栗原:
git checkout -b feature/morning-kurihara

# 猿渡:
git checkout -b feature/morning-saruwatari
```

### フェーズ 2: 全員が同じ行を変更する

`team_docs/team_rules.md` の「朝会の時間」の行を、**各自が異なる時間に変更する**。

**伊藤**: `- 朝会の時間: 10:00` → `- 朝会の時間: 9:00（早めに始めて午前を有効活用）`

**栗原**: `- 朝会の時間: 10:00` → `- 朝会の時間: 9:30（通勤ラッシュを避けたい）`

**猿渡**: `- 朝会の時間: 10:00` → `- 朝会の時間: 11:00（朝は集中作業にあてたい）`

### フェーズ 3: 全員がコミットしてプッシュする

```bash
git add team_docs/team_rules.md
git commit -m "feat: 朝会の時間を変更"
git push -u origin feature/morning-[自分の名前]
```

### フェーズ 4: 1番目の人がPRを作成してマージする

**1番目（伊藤）**: PRを作成し、レビューなしでマージする（今回は練習のため）。

1. GitHubでPRを作成
2. 「Merge pull request」→「Confirm merge」

> 1番目の人はコンフリクトなしでマージできる。

### フェーズ 5: 2番目の人がコンフリクトを体験する

**2番目（栗原）**: PRを作成すると、コンフリクトが表示される。

1. GitHubでPRを作成
2. 「This branch has conflicts that must be resolved」と表示される

**コンフリクトの解決手順**:

```bash
# 最新のmainを取得
git checkout main
git pull

# 自分のブランチに戻る
git checkout feature/morning-kurihara

# mainの変更を自分のブランチに取り込む
git merge main
```

この時点で、以下のメッセージが表示される:

```
Auto-merging team_docs/team_rules.md
CONFLICT (content): Merge conflict in team_docs/team_rules.md
Automatic merge failed; fix conflicts and then commit the result.
```

### フェーズ 6: コンフリクトを解決する

VS Codeで `team_docs/team_rules.md` を開くと、以下のような表示になる:

```
<<<<<<< HEAD
- 朝会の時間: 9:30（通勤ラッシュを避けたい）
=======
- 朝会の時間: 9:00（早めに始めて午前を有効活用）
>>>>>>> main
```

**各パーツの意味**:

| 表示 | 意味 |
|-----|------|
| `<<<<<<< HEAD` | 自分のブランチの変更ここから |
| `=======` | 区切り線 |
| `>>>>>>> main` | mainの変更ここまで |

**解決方法**:

1. チームで相談する: 「朝会の時間、どうする？」
2. 合意した内容で書き換える
3. コンフリクトマーカー（`<<<<<<<`、`=======`、`>>>>>>>`）を**全て削除する**

**解決の例**:

```markdown
- 朝会の時間: 9:30（チームで相談して決定）
```

### フェーズ 7: 解決をコミットしてプッシュする

```bash
# 解決したファイルをステージング
git add team_docs/team_rules.md

# コンフリクト解決のコミット
git commit -m "fix: 朝会の時間のコンフリクトを解決"

# プッシュ
git push
```

PRページをリロードすると、コンフリクトが解消されている。レビュー後にマージする。

### フェーズ 8: 3番目の人も同様に解決する

**3番目（猿渡）** も同じ手順でコンフリクトを解決する。

```bash
git checkout main
git pull
git checkout feature/morning-saruwatari
git merge main
# コンフリクトを解決
git add team_docs/team_rules.md
git commit -m "fix: 朝会の時間のコンフリクトを解決"
git push
```

### フェーズ 9: 全員でmainを更新する

全てのPRがマージされたら、全員がmainを更新する。

```bash
git checkout main
git pull
cat team_docs/team_rules.md
```

---

## 実験

### 実験1: コンフリクトマーカーの観察

1. コンフリクトが発生した状態で `team_docs/team_rules.md` を開く
2. `<<<<<<< HEAD` 〜 `>>>>>>> main` の間に何が書かれているか観察する
3. VS Codeの画面表示（色分け）を確認する

### 実験2: コンフリクトを解決しないでコミットしてみる

1. コンフリクトマーカーを残したまま `git add` してみる
2. `git commit` してみる

> **注意**: これは「やってはいけないこと」の確認実験。コンフリクトマーカーが残ったまま意味のないファイルになってしまうことを体験する。この実験後は必ず正しく解決し直すこと。

### 実験3: コンフリクトを防ぐ方法を考える

チームで以下を話し合う:

1. なぜ今回コンフリクトが発生したか？
2. コンフリクトを減らすにはどうすればよいか？
3. 実際のチーム開発ではどんなときにコンフリクトが起きるか？

---

## 実験レポート

`day13_report.md` として保存し、コミットすること。

```
実験1: コンフリクトマーカーの観察
  <<<<<<< HEAD と >>>>>>> main の間に書かれていたもの:（実験後に書く）
  HEAD とは何か:（考察）
  ======= は何を意味するか:（考察）

実験2: コンフリクトを解決しないでコミットしてみる
  予想:（実験前に書く — コンフリクトマーカーを残したままコミットするとどうなるか？）
  結果:（実験後に書く — 何が起きたか）
  わかったこと:（なぜコンフリクトは必ず解決しないといけないのか）

実験3: コンフリクトを防ぐ方法を考える
  コンフリクトが発生した原因:（チームの話し合い結果）
  コンフリクトを減らす方法:（チームの話し合い結果、最低3つ）
  実際の開発でコンフリクトが起きる場面:（チームの話し合い結果）
```

---

## コンフリクト解決のまとめ

### 手順チートシート

```bash
# 1. 最新のmainを取得
git checkout main
git pull

# 2. 自分のブランチに戻る
git checkout feature/[自分のブランチ名]

# 3. mainを取り込む（ここでコンフリクト発生）
git merge main

# 4. VS Codeでコンフリクトを解決
#    - <<<<<<< HEAD 〜 >>>>>>> main を探す
#    - チームと相談して内容を決める
#    - コンフリクトマーカーを全て削除する

# 5. 解決をコミット
git add [対象ファイル]
git commit -m "fix: コンフリクトを解決"
git push
```

### コンフリクトを減らすコツ

| やること | 効果 |
|---------|------|
| 作業前に `git pull` する | 最新の状態から作業を始められる |
| ブランチの寿命を短くする | 変更が溜まる前にマージできる |
| 編集する範囲を分ける | 同じファイルの同じ行を触らなくなる |
| こまめにコミュニケーションする | 誰が何を触っているか把握できる |

---

## 完了条件

- [ ] 全員が同じ行を編集してプッシュした
- [ ] 1番目の人がコンフリクトなしでマージした
- [ ] 2番目・3番目の人がコンフリクトを体験した
- [ ] コンフリクトマーカーの意味を説明できる
- [ ] コンフリクトを手順に沿って解決できた
- [ ] 全員のPRがマージされた
- [ ] コンフリクトを減らす方法を3つ以上言える
- [ ] 実験レポート（`day13_report.md`）を提出した
