# Day 9: 全層を往復 — DBのデータを画面に表示する（Read）

## 学習目標

- データの**逆方向の流れ**（DB → Server → Client）を理解する
- GET API でデータを取得する方法を学ぶ
- 画面にデータベースの内容を表示する

## ファイル構成とレイヤーの対応

Day 8 と同じプロジェクト（`day8_with_db/`）に機能を追加する。

```
day8_with_db/
├── server.js                ← Server: POST API + GET API（★ GET を追加）
├── package.json
├── public/
│   └── index.html           ← Client: 送信機能 + 一覧表示機能（★ 表示を追加）
└── prisma/
    ├── schema.prisma        ← DB定義（変更なし）
    └── dev.db               ← Database（変更なし）
```

| ファイル | Day 9 で追加する内容 |
|---------|-------------------|
| `server.js` | `GET /api/messages` エンドポイントを追加 |
| `public/index.html` | ページ読み込み時にメッセージ一覧を取得・表示する処理を追加 |
| `prisma/schema.prisma` | 変更なし |
| `prisma/dev.db` | 変更なし（Day 8 で保存したデータがそのまま入っている） |

## AIへのプロンプト（IPOカード形式）

Day 8 のプロジェクトに機能を追加する。以下のIPOカードをコピーしてAIに渡し、既存コードに追加させる。

> **IPOカード — Day 9: 全層を往復（メッセージ一覧表示 — Read）**
>
> | 層 | Input (きっかけ) | Process (処理) | Output (結果) |
> |----|-----------------|---------------|--------------|
> | **Client** | ページが読み込まれたとき（自動実行） | `fetch` で Server（`GET /api/messages`）からデータを取得する | 取得したメッセージ一覧を画面のリストに表示する |
> | **Server** | Client から `GET /api/messages` リクエストを受け取る | Prisma を使って Database の `Message` テーブルから全件取得する（新しい順） | 取得したメッセージの配列をJSONで Client に返す |
> | **Database** | Server（Prisma）から SELECT 命令を受け取る | `Message` テーブルから全レコードを `createdAt` の降順で取得する | レコードの配列を Server に返す |
>
> **編集対象ファイル（Day 8 のプロジェクトに追加）:**
> - `day8_with_db/server.js` — `GET /api/messages` エンドポイントを追加
> - `day8_with_db/public/index.html` — ページ読み込み時のデータ取得・表示処理を追加
> - `prisma/schema.prisma` — 変更なし
>
> **server.js に追加する仕様:**
> - `GET /api/messages` エンドポイント: DB から全メッセージを新しい順で取得し、JSON で返す
> - 取得時に `console.log` で `[SERVER]` プレフィックス付きのログを出す（取得件数を表示）
>
> **public/index.html に追加する仕様:**
> - ページ読み込み時に `fetch` で `GET /api/messages` を呼び、メッセージ一覧を取得する
> - 取得したメッセージを画面のリストに表示する（名前、内容、日時）
> - 取得時に `console.log` で `[CLIENT]` プレフィックス付きのログを出す
> - メッセージ送信後にも一覧を再取得して表示を更新する
>
> **データの流れ（Read — 今日追加する流れ）:**
> ```
> ページ読込 → [Client: fetch GET] ← [Server: Prismaで取得命令] ← [DB: データを返す]
>                   ↓                         ↓                            ↓
>            画面にリスト表示          ターミナルにログ              dev.db から読み出し
> ```

## 準備・実行

Day 8 のプロジェクト（`day8_with_db/`）をそのまま使う。新しいフォルダは作らない。

```bash
node server.js
```

ブラウザで `http://localhost:3000` を開く。

## ファイルの確認

AIがコードを編集したら、以下を確認する。

- [ ] `server.js` に `GET /api/messages` が追加されたか？
- [ ] `server.js` で `prisma.message.findMany()` を使ってDBからデータを取得しているか？
- [ ] `public/index.html` にページ読み込み時のデータ取得処理が追加されたか？
- [ ] `public/index.html` で取得したデータを画面に表示する処理があるか？
- [ ] `prisma/schema.prisma` は変更されていないか？

## 実験

### 実験1: ページを開いてデータを取得する

1. `node server.js` でサーバーを起動する
2. ブラウザで `http://localhost:3000` を開く
3. **Day 8 で保存したメッセージが自動的に画面に表示されることを確認する**
4. F12 Console とターミナルのログを確認する:

| 確認場所 | 表示されるログ |
|---------|--------------|
| F12 Console | `[CLIENT] 取得したメッセージ: [{...}, {...}, ...]` |
| ターミナル | `[SERVER] DBから取得: 3 件` |

5. 新しいメッセージを送信し、一覧に追加されることを確認する

### 実験2: サーバーを再起動してデータの往復を確認する

1. サーバーを停止する（Ctrl+C）
2. サーバーを再起動する（`node server.js`）
3. ブラウザで `http://localhost:3000` を開く
4. 以前のメッセージが表示されるか確認する

## 実験レポート

`day9_report.md` として保存し、コミットすること。

```
実験1: ページを開いてデータを取得する
  画面に表示されたメッセージ:（実験後に書く — Day 8 で保存したデータが出たか）
  F12 Console に表示されたログ:（実験後に書く）
  ターミナルに表示されたログ:（実験後に書く）

実験2: サーバーを再起動してデータの往復を確認する
  予想:（実験前に書く — サーバーを再起動した後、ページを開いたらデータは表示されるか？）
  結果:（実験後に書く — メッセージは表示されたか）
  わかったこと:（Read のデータの流れを自分の言葉で書く。Create との方向の違いは何か）
```

## 完了条件

- [ ] ページを開くとDBに保存済みのメッセージが表示される
- [ ] 新しいメッセージを追加すると一覧に即反映される
- [ ] サーバー再起動後もメッセージが表示される
- [ ] 実験レポート（`day9_report.md`）を提出した
- [ ] コミット＆プッシュ完了
